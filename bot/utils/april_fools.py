"""
–ú–æ–¥—É–ª—å –¥–ª—è –ø–µ—Ä–≤–æ–∞–ø—Ä–µ–ª—å—Å–∫–∏—Ö —à—É—Ç–æ–∫ –≤ –±–æ—Ç–µ.
–í–∫–ª—é—á–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∞–∫—Ç–∏–≤–Ω—ã —Ç–æ–ª—å–∫–æ 1 –∞–ø—Ä–µ–ª—è.
"""

import random
from datetime import datetime
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, Message
from bot.config import logger

# –í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–≤–æ–∞–ø—Ä–µ–ª—å—Å–∫–∏–µ —à—É—Ç–∫–∏
ENABLED = True

def is_april_fools_day() -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–µ–≥–æ–¥–Ω—è 1 –∞–ø—Ä–µ–ª—è"""
    today = datetime.now()
    return today.month == 4 and today.day == 1 and ENABLED


def get_survival_stats(schedule_type: str = None) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —à—É—Ç–æ—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    if not is_april_fools_day():
        return ""
    
    # –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
    base_probability = random.randint(50, 95)
    
    # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    modifiers = {
        "exam": -20,            # –≠–∫–∑–∞–º–µ–Ω—ã —Å–Ω–∏–∂–∞—é—Ç —à–∞–Ω—Å—ã –≤—ã–∂–∏–≤–∞–Ω–∏—è
        "consultation": +10,    # –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ–≤—ã—à–∞—é—Ç —à–∞–Ω—Å—ã
        "practice": -5,         # –ü—Ä–∞–∫—Ç–∏–∫–∞ –Ω–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∂–∞–µ—Ç —à–∞–Ω—Å—ã
        "lecture": +5,          # –õ–µ–∫—Ü–∏–∏ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–≤—ã—à–∞—é—Ç —à–∞–Ω—Å—ã
        "weekend": +30,         # –í—ã—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–∞—é—Ç —à–∞–Ω—Å—ã
    }
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ
    if schedule_type in modifiers:
        base_probability += modifiers[schedule_type]
    
    # –°–ª—É—á–∞–π–Ω—ã–π —Ä–∞–∑–±—Ä–æ—Å +/- 5%
    random_factor = random.randint(-5, 5)
    final_probability = max(1, min(99, base_probability + random_factor))
    
    # –°–ª—É—á–∞–π–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    additional_messages = [
        "–î–µ—Ä–∂–∏—Ç–µ—Å—å –∫—Ä–µ–ø—á–µ!",
        "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–∑—è—Ç—å –∑–∞–ø–∞—Å–Ω–æ–π –º–æ–∑–≥!",
        "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–º–µ—Ç—å –ø—Ä–∏ —Å–µ–±–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫.",
        "–ö–æ—Ñ–µ–∏–Ω –≤ –∫—Ä–æ–≤–∏ –ø–æ–≤—ã—Å–∏—Ç —à–∞–Ω—Å—ã –Ω–∞ 10%.",
        "–®–∞–Ω—Å —É—Å–Ω—É—Ç—å –Ω–∞ –ø–∞—Ä–µ: –≤–µ—Å—å–º–∞ –≤—ã—Å–æ–∫–∏–π.",
        "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –º–æ—Ä–≥–∞—Ç—å.",
        "–£—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π!",
        "–ó–∞–ø–∞—Å –ø–µ—á–µ–Ω–µ–∫ –ø–æ–≤—ã—Å–∏—Ç –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –Ω–∞ 5%.",
        "–ù–µ –¥—É–º–∞–π—Ç–µ –æ –∫–æ—Ç–∏–∫–∞—Ö –≤–æ –≤—Ä–µ–º—è –ø–∞—Ä—ã!"
    ]
    
    # –°–ª—É—á–∞–π–Ω—ã–π —Å–æ–≤–µ—Ç
    advice = random.choice(additional_messages)
    
    # –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = f"\n\nüìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏</b>\n"
    message += f"–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–Ω—è: <b>{final_probability}%</b>\n"
    message += f"üí° <i>{advice}</i>"
    
    return message


def get_mercy_button() -> InlineKeyboardMarkup:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–Ω–æ–ø–∫—É '–ü—Ä–æ—Å–∏—Ç—å –ø–æ—â–∞–¥—ã' –¥–ª—è –ø–µ—Ä–≤–æ–∞–ø—Ä–µ–ª—å—Å–∫–æ–π —à—É—Ç–∫–∏"""
    if not is_april_fools_day():
        return None
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É
    mercy_button = InlineKeyboardButton(text="üôè –ü—Ä–æ—Å–∏—Ç—å –ø–æ—â–∞–¥—ã", callback_data="april_fools_mercy")
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–ª—è aiogram 3.x
    keyboard = InlineKeyboardMarkup(inline_keyboard=[[mercy_button]])
    
    return keyboard


async def handle_mercy_request(message: Message) -> str:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü—Ä–æ—Å–∏—Ç—å –ø–æ—â–∞–¥—ã'"""
    if not is_april_fools_day():
        return "–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ 1 –∞–ø—Ä–µ–ª—è!"
    
    # –°–ª—É—á–∞–π–Ω—ã–µ –æ—Ç–∫–∞–∑—ã –≤ –ø–æ—â–∞–¥–µ
    mercy_denied_messages = [
        "–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω. –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ—É–º–æ–ª–∏–º–æ.",
        "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–æ –≤–∞—à—É –ø—Ä–æ—Å—å–±—É –∏... –æ—Ç–∫–∞–∑–∞–ª–æ!",
        "–•–º... –ù–µ—Ç. –ü—Ä–æ—Å—Ç–æ –Ω–µ—Ç.",
        "ERROR 404: –ü–æ—â–∞–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",
        "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–º–µ–µ—Ç—Å—è –Ω–∞–¥ –≤–∞—à–µ–π —Å–ª–∞–±–æ—Å—Ç—å—é!",
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ... –û—Ç–≤–µ—Ç: –Ω–µ—Ç.",
        "–°–µ–≥–æ–¥–Ω—è –Ω–µ –¥–µ–Ω—å –ø–æ—â–∞–¥—ã!",
        "–ö–Ω–æ–ø–∫–∞ –ø–æ—â–∞–¥—ã –æ–∫–∞–∑–∞–ª–∞—Å—å –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–π.",
        "–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑... –Ω–∏–∫–æ–≥–¥–∞!",
        "–í—ã—á–∏—Å–ª—è—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ—â–∞–¥—ã... 0%."
    ]
    
    return random.choice(mercy_denied_messages) 